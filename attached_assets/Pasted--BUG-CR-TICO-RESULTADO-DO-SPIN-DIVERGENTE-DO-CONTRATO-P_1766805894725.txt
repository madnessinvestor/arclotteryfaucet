ğŸš¨ BUG CRÃTICO â€“ RESULTADO DO SPIN DIVERGENTE DO CONTRATO
âŒ Problema atual (reproduzÃ­vel)

O frontend estÃ¡ exibindo um resultado diferente do que o contrato ArcSpinLottery efetivamente retorna.

Exemplo real:

Contrato emite evento:

SpinPlayed
reward = 100 USDC


Frontend mostra:

0 USDC


Isso caracteriza dessincronizaÃ§Ã£o grave entre UI e blockchain.

ğŸ” Causa provÃ¡vel (o que estÃ¡ errado hoje)

O frontend NÃƒO estÃ¡ usando o evento SpinPlayed como fonte Ãºnica de verdade e estÃ¡:

âŒ Recalculando o prÃªmio off-chain

âŒ Inferindo o segmento por valor local

âŒ Usando lÃ³gica prÃ³pria (ex: getPrizeIndexByBigInt, fallback, ou Math.random)

âŒ Ignorando ou sobrescrevendo o reward vindo do evento

âŒ Usando decimais incorretos (USDC â‰  18 decimais)

âœ… CORREÃ‡ÃƒO OBRIGATÃ“RIA (PASSO A PASSO)
1ï¸âƒ£ Fonte ÃšNICA do resultado

O frontend DEVE:

- Ler o receipt da transaÃ§Ã£o
- Extrair exclusivamente o evento SpinPlayed
- Usar APENAS:
  - event.reward
  - event.random


ğŸš¨ Qualquer outro cÃ¡lculo deve ser removido

2ï¸âƒ£ Reward (valor ganho)
reward = event.reward  // uint256
rewardUSDC = reward / 1e6


ğŸ“Œ O frontend NÃƒO pode:

Deduzir prÃªmio pelo roll

Deduzir prÃªmio pelo segmento

Deduzir prÃªmio pelo valor anterior

O valor exibido TEM que ser exatamente o do evento.

3ï¸âƒ£ Segmento da roleta (somente visual)

O segmento NÃƒO vem do valor, vem de:

roll = event.random % 100


E deve respeitar exatamente:

roll < 2   â†’ 1000 USDC
roll < 5   â†’ 200 USDC
roll < 15  â†’ 100 USDC
roll < 25  â†’ 50 USDC
roll < 45  â†’ 20 USDC
roll < 60  â†’ 10 USDC
roll >= 60 â†’ 0 USDC


ğŸ“Œ Esse mapeamento Ã© apenas para:

Definir Ã­ndice da roleta

Calcular Ã¢ngulo final

â— Nunca para definir o valor exibido

4ï¸âƒ£ Ordem correta de execuÃ§Ã£o (OBRIGATÃ“RIA)
1. UsuÃ¡rio confirma transaÃ§Ã£o
2. TransaÃ§Ã£o minera
3. Frontend extrai SpinPlayed do receipt
4. reward = event.reward
5. roll = event.random % 100
6. UI anima a roleta atÃ© o segmento correto
7. UI exibe reward exatamente igual ao contrato


ğŸš« Qualquer outra ordem gera dessync

5ï¸âƒ£ RemoÃ§Ãµes obrigatÃ³rias

Remover do frontend:

âŒ Qualquer cÃ¡lculo de prÃªmio off-chain

âŒ Qualquer fallback visual de resultado

âŒ FunÃ§Ãµes que deduzem segmento por valor

âŒ Uso de Math.random

âŒ LÃ³gica baseada em estado local ou cache

6ï¸âƒ£ Log obrigatÃ³rio para validaÃ§Ã£o (DEBUG)

Adicionar log temporÃ¡rio:

console.log({
  eventReward: event.reward.toString(),
  eventRandom: event.random.toString(),
  roll: event.random % 100
});


âœ” O valor logado TEM que bater com:

Evento

UI

AnimaÃ§Ã£o

ğŸ§ª CRITÃ‰RIO DE ACEITAÃ‡ÃƒO (SEM DISCUSSÃƒO)

A correÃ§Ã£o sÃ³ Ã© considerada concluÃ­da quando:

âœ” Frontend exibe exatamente event.reward

âœ” Reward 100 no contrato â†’ UI mostra 100

âœ” Reward 0 no contrato â†’ UI mostra 0

âœ” Roleta para exatamente no segmento correto

âœ” Nenhum cÃ¡lculo off-chain altera resultado